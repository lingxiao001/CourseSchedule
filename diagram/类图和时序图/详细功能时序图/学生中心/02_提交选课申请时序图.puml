@startuml 提交选课申请时序图
title 学生提交选课申请流程时序图

actor 学生 as S
participant "选课页面" as CP
participant "认证拦截器" as AI
participant "SelectionController" as SC
participant "SelectionService" as SS
participant "CourseRepository" as CR
participant "TeachingClassRepository" as TCR
participant "CourseSelectionRepository" as CSR
participant "StudentRepository" as SR
participant "Database" as DB

autonumber

note over S: 学生进行在线选课

== 浏览可选课程 ==
S -> CP: 访问选课页面
activate CP

CP -> AI: GET /api/student/courses/available
activate AI
note right: 获取可选课程列表

AI -> AI: 验证学生身份

AI -> SC: 转发请求
activate SC

SC -> SS: getAvailableCourses(studentId)
activate SS

SS -> SR: findById(studentId)
activate SR
SR -> DB: 查询学生信息
activate DB
DB -> SR: 返回学生数据
deactivate DB
SR -> SS: 返回Student对象
deactivate SR

SS -> TCR: findAvailableTeachingClasses(studentGrade, studentMajor)
activate TCR
TCR -> DB: SELECT * FROM teaching_classes WHERE capacity > current_count AND grade = ? AND major = ?
activate DB
note right: 查询有余量且适合学生的教学班
DB -> TCR: 返回可选教学班
deactivate DB
TCR -> SS: 返回教学班列表
deactivate TCR

SS -> CSR: findByStudentId(studentId)
activate CSR
CSR -> DB: SELECT * FROM course_selections WHERE student_id = ?
activate DB
note right: 查询学生已选课程
DB -> CSR: 返回已选课程
deactivate DB
CSR -> SS: 返回选课记录
deactivate CSR

SS -> SS: 过滤已选课程
note right: 移除学生已选的课程

SS -> SC: 返回可选课程列表
deactivate SS

SC -> CP: 200 OK + 课程列表
deactivate SC
deactivate AI

CP -> S: 显示可选课程
note right: 显示课程名称、教师、时间、余量等

== 提交选课申请 ==
S -> CP: 选择课程并点击选课
CP -> CP: 前端验证
note right: 检查是否时间冲突、学分限制等

alt 前端验证失败
    CP -> S: 显示验证错误
    note right: 时间冲突或学分超限
else 前端验证通过
    CP -> AI: POST /api/student/selections
    activate AI
    note right: 提交选课申请
    
    AI -> AI: 验证学生身份
    
    AI -> SC: 转发请求
    activate SC
    
    SC -> SS: submitCourseSelection(studentId, teachingClassId)
    activate SS
    
    SS -> TCR: findById(teachingClassId)
    activate TCR
    TCR -> DB: SELECT * FROM teaching_classes WHERE id = ?
    activate DB
    DB -> TCR: 返回教学班信息
    deactivate DB
    TCR -> SS: 返回TeachingClass对象
    deactivate TCR
    
    alt 教学班不存在或已满
        SS -> SC: 抛出ValidationException
        SC -> CP: 400 Bad Request
        note right: 教学班不可选
        CP -> S: 显示选课失败信息
    else 教学班可选
        SS -> CSR: findConflictSelections(studentId, timeSlots)
        activate CSR
        CSR -> DB: 查询时间冲突的选课记录
        activate DB
        DB -> CSR: 返回冲突检查结果
        deactivate DB
        CSR -> SS: 返回冲突课程
        deactivate CSR
        
        alt 存在时间冲突
            SS -> SC: 抛出ConflictException
            SC -> CP: 409 Conflict
            note right: 选课时间冲突
            CP -> S: 显示时间冲突错误
        else 无时间冲突
            SS -> CSR: countByStudentId(studentId)
            activate CSR
            CSR -> DB: SELECT COUNT(*) FROM course_selections WHERE student_id = ?
            activate DB
            DB -> CSR: 返回已选课程数量
            deactivate DB
            CSR -> SS: 返回选课数量
            deactivate CSR
            
            alt 超过选课上限
                SS -> SC: 抛出LimitExceededException
                SC -> CP: 400 Bad Request
                note right: 超过选课数量限制
                CP -> S: 显示选课数量超限错误
            else 未超过选课上限
                SS -> DB: 开始事务
                activate DB
                
                SS -> CSR: 创建选课记录
                CSR -> DB: INSERT INTO course_selections (...)
                note right: 创建选课申请记录
                
                SS -> TCR: 增加选课人数
                TCR -> DB: UPDATE teaching_classes SET current_count = current_count + 1
                note right: 更新教学班当前人数
                
                SS -> DB: 提交事务
                deactivate DB
                
                SS -> SS: 发送选课成功通知
                note right: 可选择发送邮件或系统通知
                
                SS -> SC: 返回选课成功结果
                deactivate SS
                
                SC -> CP: 201 Created + 选课结果
                deactivate SC
                deactivate AI
                
                CP -> S: 显示选课成功信息
                note right: 提示选课成功，更新课程状态
                
                CP -> CP: 刷新可选课程列表
                deactivate CP
                note right: 移除已选课程，更新余量显示
            end
        end
    end
end

note over S: 选课申请提交完成

@enduml 